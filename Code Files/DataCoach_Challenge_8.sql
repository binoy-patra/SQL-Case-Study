

CREATE TABLE datacoach.mytable (
    customer_id            INTEGER  NOT NULL PRIMARY KEY,
    number_of_transactions INTEGER  NOT NULL,
    units                  INTEGER  NOT NULL,
    revenue                NUMERIC(8,2) NOT NULL,
    margin                 NUMERIC(7,2) NOT NULL
);

INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (101,1,2,38.00,20.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (102,1,3,33.00,18.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (103,1,5,45.00,26.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (104,1,3,24.00,11.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (105,1,3,42.00,22.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (106,1,2,40.00,22.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (107,1,5,55.00,31.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (108,1,5,60.00,33.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (109,1,3,54.00,25.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (110,1,3,45.00,21.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (111,1,5,60.00,30.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (112,1,2,28.00,13.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (113,1,5,90.00,44.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (114,1,5,70.00,29.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (115,1,4,36.00,21.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (116,1,4,32.00,14.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (117,1,5,80.00,45.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (118,1,5,90.00,42.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (119,1,3,60.00,34.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (120,1,3,33.00,17.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (121,1,4,32.00,19.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (122,1,3,24.00,14.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (123,1,2,22.00,12.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (124,1,2,38.00,17.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (125,1,5,65.00,37.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (126,1,4,64.00,32.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (127,1,3,60.00,35.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (128,1,4,68.00,30.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (129,1,2,16.00,9.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (130,1,4,56.00,33.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (131,1,3,33.00,16.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (132,1,3,36.00,21.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (133,1,3,54.00,32.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (134,1,2,36.00,17.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (135,1,2,24.00,14.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (136,1,5,45.00,26.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (137,1,3,51.00,25.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (138,1,5,95.00,45.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (139,1,3,24.00,10.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (140,2,8,104.00,50.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (141,2,10,120.00,54.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (142,2,6,102.00,57.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (143,2,4,68.00,41.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (144,2,4,60.00,29.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (145,2,8,96.00,50.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (146,2,8,112.00,52.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (147,2,4,60.00,32.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (148,2,8,144.00,66.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (149,2,10,80.00,35.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (150,2,4,68.00,33.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (151,2,10,170.00,90.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (152,2,6,120.00,50.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (153,2,6,48.00,23.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (154,2,10,170.00,87.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (155,2,6,48.00,21.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (156,2,8,64.00,33.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (157,2,6,66.00,28.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (158,2,10,140.00,84.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (159,2,6,90.00,50.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (160,2,10,90.00,53.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (161,2,10,150.00,74.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (162,2,4,68.00,33.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (163,2,6,60.00,32.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (164,2,8,112.00,55.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (165,2,4,56.00,31.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (166,2,4,40.00,21.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (167,2,4,64.00,30.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (168,2,8,88.00,47.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (169,2,4,72.00,40.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (170,2,10,130.00,57.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (171,2,4,40.00,22.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (172,2,6,108.00,43.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (173,3,9,162.00,83.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (174,3,6,78.00,37.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (175,3,9,180.00,88.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (176,3,15,210.00,116.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (177,3,15,150.00,66.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (178,3,6,90.00,36.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (179,3,6,120.00,49.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (180,3,9,99.00,46.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (181,3,12,132.00,71.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (182,3,9,72.00,32.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (183,3,15,285.00,120.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (184,3,12,192.00,102.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (185,4,12,240.00,122.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (186,4,8,120.00,48.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (187,4,12,132.00,53.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (188,4,20,380.00,190.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (189,4,8,104.00,43.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (190,4,16,224.00,113.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (191,4,12,156.00,72.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (192,4,20,340.00,173.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (193,4,16,160.00,84.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (194,4,20,380.00,197.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (195,4,12,180.00,89.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (196,4,16,288.00,152.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (197,4,16,176.00,90.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (198,4,8,112.00,43.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (199,4,8,120.00,60.00);
INSERT INTO datacoach.mytable (customer_id, number_of_transactions, units, revenue, margin) VALUES (200,4,16,160.00,84.00);

COMMIT;

-- -------------------------------------  ----------------------------------------------

-- 1. Find the mean number of transactions per customer, mean number of units per customer, mean revenue per customer, mean margin per customer and mean margin rate per customer.
SELECT 
    round(AVG(number_of_transactions),2) AS mean_transactions_per_customer,
    round(AVG(units),2) AS mean_units_per_customer,
    round(AVG(revenue),2) AS mean_revenue_per_customer,
    round(AVG(margin),2) AS mean_margin_per_customer,
    round(AVG((margin / revenue) * 100),2) AS mean_margin_rate_per_customer
FROM 
    datacoach.mytable;
    
-- 2. Find the median for all of the above.
WITH ranked_table AS (
    SELECT 
        number_of_transactions,
        units,
        revenue,
        margin,
        (margin / revenue) * 100 AS margin_rate,
        ROW_NUMBER() OVER (ORDER BY number_of_transactions) AS transaction_rank,
        ROW_NUMBER() OVER (ORDER BY units) AS units_rank,
        ROW_NUMBER() OVER (ORDER BY revenue) AS revenue_rank,
        ROW_NUMBER() OVER (ORDER BY margin) AS margin_rank,
        ROW_NUMBER() OVER (ORDER BY (margin / revenue) * 100) AS margin_rate_rank,
        COUNT(*) OVER () AS total_rows
    FROM 
        datacoach.mytable
)
SELECT 
    AVG(number_of_transactions) AS median_transactions_per_customer,
    AVG(units) AS median_units_per_customer,
    AVG(revenue) AS median_revenue_per_customer,
    AVG(margin) AS median_margin_per_customer,
    AVG(margin_rate) AS median_margin_rate_per_customer
FROM 
    ranked_table
WHERE 
    transaction_rank IN (CEIL(total_rows/2), FLOOR(total_rows/2) + 1)
    OR units_rank IN (CEIL(total_rows/2), FLOOR(total_rows/2) + 1)
    OR revenue_rank IN (CEIL(total_rows/2), FLOOR(total_rows/2) + 1)
    OR margin_rank IN (CEIL(total_rows/2), FLOOR(total_rows/2) + 1)
    OR margin_rate_rank IN (CEIL(total_rows/2), FLOOR(total_rows/2) + 1);


-- 3. How could the business be impacted if they only use the mean when discussing their customers?

-- 4. Calculate the average item value and average order value for each customer. Then find the mean and median of these.
SELECT 
round(AVG(A.avg_item_value),2) AS mean_item_value,
round(AVG(avg_order_value),2) AS mean_order_value
FROM 
(SELECT 
    customer_id,
    round(SUM(revenue) / SUM(units) ,2) AS avg_item_value,
    round(SUM(revenue) / SUM(number_of_transactions) ,2) AS avg_order_value
FROM datacoach.mytable
GROUP BY customer_id) A;

-- 5. Calculate how the average order value changes for customers by the number of transactions they have.
SELECT 
    number_of_transactions,
    ROUND(AVG(revenue / number_of_transactions), 2) AS avg_order_value
FROM 
    datacoach.mytable
GROUP BY 
    number_of_transactions;
    
-- 6. What percentage of the revenue do the top 10% of customers account for?
SELECT 
    ROUND(SUM(sub.revenue) / total_revenue * 100, 2) AS percentage_of_revenue
FROM 
    (SELECT 
        customer_id,
        revenue,
        @total_revenue := @total_revenue + revenue AS cumulative_revenue
    FROM 
        datacoach.mytable
    CROSS JOIN 
        (SELECT @total_revenue := 0) AS init
    ORDER BY 
        revenue DESC
    ) AS sub
JOIN 
    (SELECT 
        SUM(revenue) AS total_revenue
    FROM 
        datacoach.mytable
    ) AS total
ON 
    sub.cumulative_revenue <= total.total_revenue * 0.1;

-- 7. Show the distributions of transactions, units, revenue, margin and margin rate.
-- Distribution of Transactions
SELECT
    COUNT(*) AS total_transactions
FROM datacoach.mytable;

-- Distribution of Units
SELECT
    SUM(units) AS total_units,
    AVG(units) AS average_units,
    MIN(units) AS min_units,
    MAX(units) AS max_units
FROM datacoach.mytable;

-- Distribution of Revenue
SELECT
    SUM(revenue) AS total_revenue,
    AVG(revenue) AS average_revenue,
    MIN(revenue) AS min_revenue,
    MAX(revenue) AS max_revenue
FROM datacoach.mytable;

-- Distribution of Margin
SELECT
    SUM(margin) AS total_margin,
    AVG(margin) AS average_margin,
    MIN(margin) AS min_margin,
    MAX(margin) AS max_margin
FROM datacoach.mytable;

-- Distribution of Margin Rate
SELECT
    AVG(margin / revenue * 100) AS average_margin_rate
FROM datacoach.mytable;

-- 8. Make comment on the distributions and what it means for your business.